class CultivationMap{constructor(t){this.canvas=document.getElementById(t),this.canvas_width=this.canvas.clientWidth,this.canvas_height=this.canvas.clientHeight,this.ctx=this.canvas.getContext("2d"),this.dead_pat=new Image,this.dead_pat.src="./img/pluspat1.png",this.dead_color={},this.dead_area_set=[],this.plant_color={},this.plant_area_set=[],this.direction=new Image,this.direction.src="./img/direction1.png",this.area_w=100,this.area_h=100,this.basic_font="12px 'MS P Gothic'",this.set_direction(null,0,0)}set_size(t,s){this.area_w=t,this.area_h=s}set_margin(t){this.canvas.style.margin=t}set_dead_color(t,s){this.dead_color[t]=s}add_dead(t,s,e,i,a){this.dead_area_set.push({dead_name:t,x:s,y:e,w:i,h:a})}set_plant_color(t,s){this.plant_color[t]=s}set_plants(t){for(let[s,e]of Object.entries(t.get_colors()))this.plant_color[s]=e}set_basic_font(t){this.basic_font=t}add_plant(t,s,e,i,a){this.plant_area_set.push({plant_name:t,x:s,y:e,w:i,h:a})}add_plant_font(t,s,e,i,a,h){this.plant_area_set.push({plant_name:t,x:s,y:e,w:i,h:a,font:h})}draw(){for(let t=0;t<this.dead_area_set.length;t++){let s=this.dead_area_set[t];this.draw_dead_(s,this.dead_color[s.dead_name])}for(let e=0;e<this.plant_area_set.length;e++){let i=this.plant_area_set[e];this.draw_plant_(i,this.plant_color[i.plant_name])}null!=this.ang&&this.draw_direction_(this.ang,this.ang_x,this.ang_y),this.ctx.strokeStyle="black",this.ctx.strokeRect(0,0,this.canvas_width,this.canvas_height)}draw_dead_(t,s){let{x:e,y:i,w:a,h}=this.get_rect_(t);this.ctx.fillStyle=s,this.ctx.fillRect(e,i,a,h);let n=this.ctx.createPattern(this.dead_pat,"repeat");this.ctx.fillStyle=n,this.ctx.fillRect(e,i,a,h)}set_font_(t){this.ctx.font=t,this.font_size=parseInt(t.match(/(\d+)px/)[1])}draw_plant_(t,s){this.ctx.fillStyle=s;let{x:e,y:i,w:a,h}=this.get_rect_(t);if(this.ctx.fillRect(e,i,a,h),void 0==t.font)this.set_font_(this.basic_font);else{if("noname"==t.font)return;this.set_font_(t.font)}this.ctx.fillStyle="black";let n=this.ctx.measureText(t.plant_name);if(a>n.width+2){let l=e+(a-n.width)/2,c=i+(h+this.font_size)/2;this.ctx.fillText(t.plant_name,l,c)}else{let r=t.plant_name,d=Math.ceil(r.length/2),o=r.slice(0,d),x=r.slice(d),f=this.ctx.measureText(o),p=e+(a-f.width)/2,g=i+h/4+this.font_size/2,w=i+3*h/4+this.font_size/2;this.ctx.fillText(o,p,g),this.ctx.fillText(x,p,w)}}get_rect_(t){let s=this.canvas_width/this.area_w,e=this.canvas_height/this.area_h,i=t.x*s,a=t.y*e,h=t.w*s,n=t.h*e;return{x:i,y:a,w:h,h:n}}set_direction(t,s,e){this.ang=t,this.ang_x=s,this.ang_y=e}draw_direction_(t,s,e){this.ctx.save(),this.ctx.translate(25+s,25+e),this.ctx.rotate(t*Math.PI/180),this.ctx.translate(-25,-25),this.ctx.drawImage(this.direction,0,0),this.ctx.restore()}}