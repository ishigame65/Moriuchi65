class CultivationPlan{constructor(t){this.canvas=document.getElementById(t),this.canvas_width=this.canvas.clientWidth,this.canvas_height=this.canvas.clientHeight,this.ctx=this.canvas.getContext("2d"),this.act_color={},this.status_color={},this.status_opacity=.5,this.click_method=[],this.dataset=null,this.methodset=null,this.bgcolor="white",this.set_font("14px 'MS P Gothic'"),this.padding=10,this.border_width=.25,this.border_color="gray",this.month_bgcolor=null,this.is_legend=!0,this.today_width=.5,this.today_color=null}set_dataset(t){this.dataset=t}set_methodset(t){this.methodset=t}add_action(t,i){this.act_color[t]=i}add_status(t,i){this.status_color[t]=i}set_status_opacity(t){this.status_opacity=t}set_bgcolor(t){this.bgcolor=t}set_font(t){this.ctx.font=t,this.font_size=parseInt(t.match(/(\d+)px/)[1]),this.ystep=2*this.font_size}set_padding(t){this.padding=t}set_border(t,i){this.border_width=t,this.border_color=i}set_month_bgcolor(t){this.month_bgcolor=t}hide_legend(){this.is_legend=!1}set_today(t,i){this.today_width=t,this.today_color=i}draw(){this.ctx.fillStyle=this.bgcolor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.label_width=this.get_max_name_width_(this.dataset)+10,this.xzero=this.padding+this.label_width+1,this.xstep=(this.canvas_width-this.label_width-2*this.padding)/36,this.draw_month_(this.dataset.length);let t=this.padding+this.ystep;for(let i=0;i<this.dataset.length;i++){let s=this.dataset[i],h=[];for(let e in s)switch(e){case"name":case"color":case"status":break;default:void 0!==this.act_color[e]&&h.push(e)}let l=[],d=Array(36).fill(0),o=!1;for(let a=0;a<h.length;a++){let r=h[a],{start:c,end:n}=this.get_period_(s[r]),x=0;if(c<n){for(let g=c;g<n;g++)if(0!=d[g]){x=1;break}if(0==x)for(let p=c;p<n;p++)d[p]=a+1;else o=!0}else{for(let f=c;f<36;f++)if(0!=d[f]){x=1;break}if(0==x){for(let w=0;w<n;w++)if(0!=d[w]){x=1;break}}if(0==x){for(let _=c;_<36;_++)d[_]=a+1;for(let y=0;y<n;y++)d[y]=a+1}else o=!0}l.push({key:r,start:c,end:n,ypos:t,y2nd:x})}let b=this.ystep;o&&(b+=this.ystep/2),this.draw_name_(t,b,s.color,"black",s.name);for(let $=1;$<=12;$++){let u=this.xzero+($-1)*3*this.xstep;this.draw_line_(u,t,u,t+b,this.border_color,this.border_width)}let m=this.xzero+36*this.xstep;this.draw_line_(m-1,t,m-1,t+b,this.border_color,this.border_width);let z=0;for(let v=0;v<l.length;v++){let{key:k,start:S,end:R,ypos:T,y2nd:D}=l[v],P=this.methodset.get(`${s.name}:${k}`);o&&(z=0==D?-1:1),this.draw_period_(T,z,this.act_color[k],S,R,P)}void 0!==this.status_color[s.status]&&this.draw_status_(t,b,this.status_color[s.status],this.status_opacity),this.draw_line_(this.padding,t,this.canvas_width-this.padding,t,this.border_color,this.border_width),t+=b}this.draw_line_(this.padding,t,this.canvas_width-this.padding,t,this.border_color,this.border_width);let A=this.padding+this.ystep;null!=this.today_color&&this.draw_today_(A,t-A,this.today_color,this.today_width),this.is_legend&&this.draw_legend_(t)}action_clicked(t,i){let s="DarkBlue",h="rgba(255,255,255,0.75)";for(let e=0;e<this.click_method.length;e++){let l=this.click_method[e];if(t>=l.x&&t<=l.x+l.w&&i>=l.y&&i<=l.y+l.h){let d=l.y+l.h/2;this.ctx.fillStyle=s,this.ctx.fillRect(l.x+4,d-2,l.w-8,4);let o=l.y+l.h,a=l.method;for(;a.length>0;){let r=a.indexOf("。");if((r>22||-1==r&&a.length>22)&&(r=22),-1==r){let c=this.ctx.measureText(a).width;this.ctx.fillStyle=h,this.ctx.fillRect(this.xzero+1,o+1,c+5,this.font_size+4),o+=this.font_size+1,this.ctx.fillStyle=s,this.ctx.fillText(a,this.xzero+3,o);break}let n=a.substring(0,r+1),x=this.ctx.measureText(n).width;this.ctx.fillStyle=h,this.ctx.fillRect(this.xzero+1,o+1,x+5,this.font_size+4),o+=this.font_size+1,this.ctx.fillStyle=s,this.ctx.fillText(n,this.xzero+3,o),a=a.substring(r+1)}break}}}get_max_name_width_(t){let i=0;for(let s=0;s<t.length;s++){let h=this.ctx.measureText(t[s].name).width;h>i&&(i=h)}return i}draw_month_(t){null!=this.month_bgcolor&&(this.ctx.fillStyle=this.month_bgcolor,this.xzero,this.ctx.fillRect(this.xzero+1,this.padding+1,36*this.xstep-2,this.ystep-1)),this.ctx.fillStyle="black",this.draw_line_(this.padding,this.padding,this.canvas_width-this.padding,this.padding,this.border_color,this.border_width),this.draw_line_(this.padding,this.padding,this.padding,this.padding+this.ystep,this.border_color,this.border_width);for(let i=1;i<=12;i++){let s=this.xzero+(i-1)*3*this.xstep;this.draw_line_(s,this.padding,s,this.padding+this.ystep,this.border_color,this.border_width);let h=String(i),e=this.ctx.measureText(h),l=(3*this.xstep-e.width)/2,d=this.padding+this.ystep/2+this.font_size/2;this.ctx.fillText(h,s+l,d)}let o=this.xzero+36*this.xstep;this.draw_line_(o-1,this.padding,o-1,this.padding+this.ystep,this.border_color,this.border_width)}draw_name_(t,i,s,h,e){null!=s&&void 0!==s&&(this.ctx.fillStyle=s,this.ctx.fillRect(this.padding,t+1,this.label_width,i-1)),this.draw_line_(this.padding,t,this.padding,t+i,this.border_color,this.border_width);let l=this.ctx.measureText(e),d=this.padding+(this.label_width-l.width)/2,o=i/2+this.font_size/2;this.ctx.fillStyle=h,this.ctx.fillText(e,d,t+o)}get_period_(t){let i={a:0,b:1,c:2},s=t.split("-"),h=i[s[0].slice(-1)],e=void 0===h?(+s[0]-1)*3:(+s[0].slice(0,-1)-1)*3+h,l=i[s[1].slice(-1)],d=void 0===l?3*+s[1]:(+s[1].slice(0,-1)-1)*3+l+1;return{start:e,end:d}}draw_period_(t,i,s,h,e,l){if(void 0===s)return;let d=t+this.ystep/4;1==i&&(d+=this.ystep/2);let o=this.ystep/2,a=h*this.xstep,r=e*this.xstep,c=this.xzero+a+1,n=d+o/2;if(h<e){let x=r-a-2;this.ctx.fillStyle=s,this.ctx.fillRect(c,d,x,o),void 0!=l&&(this.click_method.push({x:c,y:d,w:x,h:o,method:l}),this.ctx.fillStyle="rgba(255,255,255,0.5)",this.ctx.fillRect(c+4,n-2,x-8,4))}else{let g=36*this.xstep,p=g-a-2,f=this.xzero+1,w=r-2;this.ctx.fillStyle=s,this.ctx.fillRect(c,d,p,o),this.ctx.fillRect(f,d,w,o),void 0!=l&&(this.click_method.push({x:c,y:d,w:p,h:o,method:l}),this.click_method.push({x:f,y:d,w:w,h:o,method:l}),this.ctx.fillStyle="rgba(255,255,255,0.5)",this.ctx.fillRect(c+4,n-2,p-8,4),this.ctx.fillRect(f+4,n-2,w-8,4))}}draw_status_(t,i,s,h){this.ctx.globalAlpha=h,this.ctx.fillStyle=s,this.ctx.fillRect(this.padding+1,t+1,this.label_width+36*this.xstep-2,i-1),this.ctx.globalAlpha=1}draw_legend_(t){let i=3*this.ystep/5,s=2*this.padding;t+=this.padding+2;let h=100;for(let e in this.act_color){this.ctx.fillStyle=this.act_color[e],this.ctx.fillRect(s,t+1,30,i+1),this.ctx.fillStyle="black";let l=this.ctx.measureText(e);l.width>h&&(h=l.width);let d=30+this.padding/2;s+=d;let o=i/2+this.font_size/2;this.ctx.fillText(e,s,t+o),(s+=l.width+this.padding+2)>this.canvas_width-(h+d+this.padding+2)&&(s=2*this.padding,t+=i+this.padding)}if(null!=this.today_color){s+=this.padding/2,this.draw_line_(s,t,s,t+i,this.today_color,this.today_width),s+=this.padding/2;let a=i/2+this.font_size/2;this.ctx.fillText("今日",s,t+a)}}draw_today_(t,i,s,h){let e=new Date,l=e.getMonth(),d=e.getDate(),o=this.xzero+(3*l+d/10)*this.xstep;this.ctx.setLineDash([10,10]),this.draw_line_(o,t,o,t+i,s,h),this.ctx.setLineDash([])}draw_line_(t,i,s,h,e,l){this.ctx.lineWidth=l,this.ctx.strokeStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(s,h),this.ctx.closePath(),this.ctx.stroke()}}