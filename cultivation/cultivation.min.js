/**
 * @fileoverview 菜園カレンダー・菜園マップ・栽培記録を作成するためのライブラリです。
 *
 * 栽培ライブラリ（cultivation）は以下の4クラスで構成されます
 *  - CultivationPlan      栽培計画クラス
 *  - CultivationMap       栽培地図クラス
 *  - CultivationLog       栽培記録クラス
 *  - CultivationPlants    栽培植物クラス
 *
 * @author      moriuchi <moriuchi@ymail.ne.jp>
 * @copyright   2025 moriuchi
 * @license     http://www.opensource.org/licenses/mit-license.html  MIT License
 * @version     0.1
 * @filename    cultivation.min.js
 * @encoding    UTF-8
 * @edit        2025/06/04  CultivationPlan     初期実装
 * @edit        2025/06/10  CultivationLog      初期実装
 * @edit        2025/06/15  CultivationMap      初期実装
 * @edit        2025/06/22  CultivationPlants   初期実装
 * @edit        2025/06/22  CultivationMap      機能追加
 * @edit        2025/07/11  CultivationPlan     機能追加
 */ class CultivationPlants{constructor(){this.plant_color={}}set_color(t,i){this.plant_color[t]=i}get_colors(){return this.plant_color}}class CultivationPlan{constructor(t){this.canvas=document.getElementById(t),this.canvas_width=this.canvas.clientWidth,this.canvas_height=this.canvas.clientHeight,this.ctx=this.canvas.getContext("2d"),this.act_color={},this.status_color={},this.status_opacity=.5,this.click_method=[],this.dataset=null,this.methodset=null,this.bgcolor="white",this.set_font("14px 'MS P Gothic'"),this.padding=10,this.border_width=.25,this.border_color="gray",this.month_bgcolor=null,this.is_legend=!0,this.today_width=.5,this.today_color=null}set_dataset(t){this.dataset=t}set_methodset(t){this.methodset=t}add_action(t,i){this.act_color[t]=i}add_status(t,i){this.status_color[t]=i}set_status_opacity(t){this.status_opacity=t}set_bgcolor(t){this.bgcolor=t}set_font(t){this.ctx.font=t,this.font_size=parseInt(t.match(/(\d+)px/)[1]),this.ystep=2*this.font_size}set_padding(t){this.padding=t}set_border(t,i){this.border_width=t,this.border_color=i}set_month_bgcolor(t){this.month_bgcolor=t}hide_legend(){this.is_legend=!1}set_today(t,i){this.today_width=t,this.today_color=i}draw(){this.ctx.fillStyle=this.bgcolor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.label_width=this.get_max_name_width_(this.dataset)+10,this.xzero=this.padding+this.label_width+1,this.xstep=(this.canvas_width-this.label_width-2*this.padding)/36,this.draw_month_(this.dataset.length);let t=this.padding+this.ystep;for(let i=0;i<this.dataset.length;i++){let s=this.dataset[i],e=[];for(let l in s)switch(l){case"name":case"color":case"status":break;default:void 0!==this.act_color[l]&&e.push(l)}let h=[],a=Array(36).fill(0),o=!1;for(let d=0;d<e.length;d++){let c=e[d],{start:n,end:r}=this.get_period_(s[c]),p=0;if(n<r){for(let g=n;g<r;g++)if(0!=a[g]){p=1;break}if(0==p)for(let x=n;x<r;x++)a[x]=d+1;else o=!0}else{for(let f=n;f<36;f++)if(0!=a[f]){p=1;break}if(0==p){for(let u=0;u<r;u++)if(0!=a[u]){p=1;break}}if(0==p){for(let w=n;w<36;w++)a[w]=d+1;for(let b=0;b<r;b++)a[b]=d+1}else o=!0}h.push({key:c,start:n,end:r,ypos:t,y2nd:p})}let $=this.ystep;o&&($+=this.ystep/2),this.draw_name_(t,$,s.color,"black",s.name);for(let y=1;y<=12;y++){let _=this.xzero+(y-1)*3*this.xstep;this.draw_line_(_,t,_,t+$,this.border_color,this.border_width)}let m=this.xzero+36*this.xstep;this.draw_line_(m-1,t,m-1,t+$,this.border_color,this.border_width);let v=0;for(let k=0;k<h.length;k++){let{key:z,start:S,end:T,ypos:R,y2nd:L}=h[k],A=this.methodset.get(`${s.name}:${z}`);o&&(v=0==L?-1:1),this.draw_period_(R,v,this.act_color[z],S,T,A)}void 0!==this.status_color[s.status]&&this.draw_status_(t,$,this.status_color[s.status],this.status_opacity),this.draw_line_(this.padding,t,this.canvas_width-this.padding,t,this.border_color,this.border_width),t+=$}this.draw_line_(this.padding,t,this.canvas_width-this.padding,t,this.border_color,this.border_width);let P=this.padding+this.ystep;null!=this.today_color&&this.draw_today_(P,t-P,this.today_color,this.today_width),this.is_legend&&this.draw_legend_(t)}action_clicked(t,i){let s="DarkBlue",e="rgba(255,255,255,0.75)";for(let l=0;l<this.click_method.length;l++){let h=this.click_method[l];if(t>=h.x&&t<=h.x+h.w&&i>=h.y&&i<=h.y+h.h){let a=h.y+h.h/2;this.ctx.fillStyle=s,this.ctx.fillRect(h.x+4,a-2,h.w-8,4);let o=h.y+h.h,d=h.method;for(;d.length>0;){let c=d.indexOf("。");if((c>22||-1==c&&d.length>22)&&(c=22),-1==c){let n=this.ctx.measureText(d).width;this.ctx.fillStyle=e,this.ctx.fillRect(this.xzero+1,o+1,n+5,this.font_size+4),o+=this.font_size+1,this.ctx.fillStyle=s,this.ctx.fillText(d,this.xzero+3,o);break}let r=d.substring(0,c+1),p=this.ctx.measureText(r).width;this.ctx.fillStyle=e,this.ctx.fillRect(this.xzero+1,o+1,p+5,this.font_size+4),o+=this.font_size+1,this.ctx.fillStyle=s,this.ctx.fillText(r,this.xzero+3,o),d=d.substring(c+1)}break}}}get_max_name_width_(t){let i=0;for(let s=0;s<t.length;s++){let e=this.ctx.measureText(t[s].name).width;e>i&&(i=e)}return i}draw_month_(t){null!=this.month_bgcolor&&(this.ctx.fillStyle=this.month_bgcolor,this.xzero,this.ctx.fillRect(this.xzero+1,this.padding+1,36*this.xstep-2,this.ystep-1)),this.ctx.fillStyle="black",this.draw_line_(this.padding,this.padding,this.canvas_width-this.padding,this.padding,this.border_color,this.border_width),this.draw_line_(this.padding,this.padding,this.padding,this.padding+this.ystep,this.border_color,this.border_width);for(let i=1;i<=12;i++){let s=this.xzero+(i-1)*3*this.xstep;this.draw_line_(s,this.padding,s,this.padding+this.ystep,this.border_color,this.border_width);let e=String(i),l=this.ctx.measureText(e),h=(3*this.xstep-l.width)/2,a=this.padding+this.ystep/2+this.font_size/2;this.ctx.fillText(e,s+h,a)}let o=this.xzero+36*this.xstep;this.draw_line_(o-1,this.padding,o-1,this.padding+this.ystep,this.border_color,this.border_width)}draw_name_(t,i,s,e,l){null!=s&&void 0!==s&&(this.ctx.fillStyle=s,this.ctx.fillRect(this.padding,t+1,this.label_width,i-1)),this.draw_line_(this.padding,t,this.padding,t+i,this.border_color,this.border_width);let h=this.ctx.measureText(l),a=this.padding+(this.label_width-h.width)/2,o=i/2+this.font_size/2;this.ctx.fillStyle=e,this.ctx.fillText(l,a,t+o)}get_period_(t){let i={a:0,b:1,c:2},s=t.split("-"),e=i[s[0].slice(-1)],l=void 0===e?(+s[0]-1)*3:(+s[0].slice(0,-1)-1)*3+e,h=i[s[1].slice(-1)],a=void 0===h?3*+s[1]:(+s[1].slice(0,-1)-1)*3+h+1;return{start:l,end:a}}draw_period_(t,i,s,e,l,h){if(void 0===s)return;let a=t+this.ystep/4;1==i&&(a+=this.ystep/2);let o=this.ystep/2,d=e*this.xstep,c=l*this.xstep,n=this.xzero+d+1,r=a+o/2;if(e<l){let p=c-d-2;this.ctx.fillStyle=s,this.ctx.fillRect(n,a,p,o),void 0!=h&&(this.click_method.push({x:n,y:a,w:p,h:o,method:h}),this.ctx.fillStyle="rgba(255,255,255,0.5)",this.ctx.fillRect(n+4,r-2,p-8,4))}else{let g=36*this.xstep,x=g-d-2,f=this.xzero+1,u=c-2;this.ctx.fillStyle=s,this.ctx.fillRect(n,a,x,o),this.ctx.fillRect(f,a,u,o),void 0!=h&&(this.click_method.push({x:n,y:a,w:x,h:o,method:h}),this.click_method.push({x:f,y:a,w:u,h:o,method:h}),this.ctx.fillStyle="rgba(255,255,255,0.5)",this.ctx.fillRect(n+4,r-2,x-8,4),this.ctx.fillRect(f+4,r-2,u-8,4))}}draw_status_(t,i,s,e){this.ctx.globalAlpha=e,this.ctx.fillStyle=s,this.ctx.fillRect(this.padding+1,t+1,this.label_width+36*this.xstep-2,i-1),this.ctx.globalAlpha=1}draw_legend_(t){let i=3*this.ystep/5,s=2*this.padding;t+=this.padding+2;let e=100;for(let l in this.act_color){this.ctx.fillStyle=this.act_color[l],this.ctx.fillRect(s,t+1,30,i+1),this.ctx.fillStyle="black";let h=this.ctx.measureText(l);h.width>e&&(e=h.width);let a=30+this.padding/2;s+=a;let o=i/2+this.font_size/2;this.ctx.fillText(l,s,t+o),(s+=h.width+this.padding+2)>this.canvas_width-(e+a+this.padding+2)&&(s=2*this.padding,t+=i+this.padding)}if(null!=this.today_color){s+=this.padding/2,this.draw_line_(s,t,s,t+i,this.today_color,this.today_width),s+=this.padding/2;let d=i/2+this.font_size/2;this.ctx.fillText("今日",s,t+d)}}draw_today_(t,i,s,e){let l=new Date,h=l.getMonth(),a=l.getDate(),o=this.xzero+(3*h+a/10)*this.xstep;this.ctx.setLineDash([10,10]),this.draw_line_(o,t,o,t+i,s,e),this.ctx.setLineDash([])}draw_line_(t,i,s,e,l,h){this.ctx.lineWidth=h,this.ctx.strokeStyle=l,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(s,e),this.ctx.closePath(),this.ctx.stroke()}}class CultivationMap{constructor(t){this.canvas=document.getElementById(t),this.canvas_width=this.canvas.clientWidth,this.canvas_height=this.canvas.clientHeight,this.ctx=this.canvas.getContext("2d"),this.dead_pat=new Image,this.dead_pat.src="pluspat1.png",this.dead_color={},this.dead_area_set=[],this.plant_color={},this.plant_area_set=[],this.direction=new Image,this.direction.src="direction1.png",this.area_w=100,this.area_h=100,this.basic_font="12px 'MS P Gothic'",this.set_direction(null,0,0)}set_size(t,i){this.area_w=t,this.area_h=i}set_margin(t){this.canvas.style.margin=t}set_dead_color(t,i){this.dead_color[t]=i}add_dead(t,i,s,e,l){this.dead_area_set.push({dead_name:t,x:i,y:s,w:e,h:l})}set_plant_color(t,i){this.plant_color[t]=i}set_plants(t){for(let[i,s]of Object.entries(t.get_colors()))this.plant_color[i]=s}set_basic_font(t){this.basic_font=t}add_plant(t,i,s,e,l){this.plant_area_set.push({plant_name:t,x:i,y:s,w:e,h:l})}add_plant_font(t,i,s,e,l,h){this.plant_area_set.push({plant_name:t,x:i,y:s,w:e,h:l,font:h})}draw(){for(let t=0;t<this.dead_area_set.length;t++){let i=this.dead_area_set[t];this.draw_dead_(i,this.dead_color[i.dead_name])}for(let s=0;s<this.plant_area_set.length;s++){let e=this.plant_area_set[s];this.draw_plant_(e,this.plant_color[e.plant_name])}null!=this.ang&&this.draw_direction_(this.ang,this.ang_x,this.ang_y),this.ctx.strokeStyle="black",this.ctx.strokeRect(0,0,this.canvas_width,this.canvas_height)}draw_dead_(t,i){let{x:s,y:e,w:l,h}=this.get_rect_(t);this.ctx.fillStyle=i,this.ctx.fillRect(s,e,l,h);let a=this.ctx.createPattern(this.dead_pat,"repeat");this.ctx.fillStyle=a,this.ctx.fillRect(s,e,l,h)}set_font_(t){this.ctx.font=t,this.font_size=parseInt(t.match(/(\d+)px/)[1])}draw_plant_(t,i){this.ctx.fillStyle=i;let{x:s,y:e,w:l,h}=this.get_rect_(t);if(this.ctx.fillRect(s,e,l,h),void 0==t.font)this.set_font_(this.basic_font);else{if("noname"==t.font)return;this.set_font_(t.font)}this.ctx.fillStyle="black";let a=this.ctx.measureText(t.plant_name);if(l>a.width+2){let o=s+(l-a.width)/2,d=e+(h+this.font_size)/2;this.ctx.fillText(t.plant_name,o,d)}else{let c=t.plant_name,n=Math.ceil(c.length/2),r=c.slice(0,n),p=c.slice(n),g=this.ctx.measureText(r),x=s+(l-g.width)/2,f=e+h/4+this.font_size/2,u=e+3*h/4+this.font_size/2;this.ctx.fillText(r,x,f),this.ctx.fillText(p,x,u)}}get_rect_(t){let i=this.canvas_width/this.area_w,s=this.canvas_height/this.area_h,e=t.x*i,l=t.y*s,h=t.w*i,a=t.h*s;return{x:e,y:l,w:h,h:a}}set_direction(t,i,s){this.ang=t,this.ang_x=i,this.ang_y=s}draw_direction_(t,i,s){this.ctx.save(),this.ctx.translate(25+i,25+s),this.ctx.rotate(t*Math.PI/180),this.ctx.translate(-25,-25),this.ctx.drawImage(this.direction,0,0),this.ctx.restore()}}class CultivationLog{constructor(t){this.log_elem=document.getElementById(t),this.articles=[],this.label_list_class="label_style0",this.label_lineheight=null,this.label_gap=null}add_log(t,i,s,e){let l=`<div class="name">${t}</div>`,h=s.split(", "),a=this.articles.find(i=>i.name==t),o=`<div class="date">${i}</div>`;for(let d=0;d<h.length;d++)o+=`<img src="${h[d]}">`;if(void 0==e&&(e=""),o+='<p class="popup-text">'+e+"</p>",void 0==a){let c=l+o;this.articles.push({name:t,content:c})}else a.content+=o}set_logs(){this.log_elem.innerHTML=this.get_logs_()}set_label_style(t){switch(t){case 1:this.label_list_class="label_style1";break;case 2:this.label_list_class="label_style2";break;default:this.label_list_class="label_style0"}}set_label_lineheight(t){this.label_lineheight=`line-height:${t};`}set_label_gap(t){this.label_gap=`gap:${t};`}set_margin(t){this.log_elem.style.margin=t}get_logs_(){let t="";(null!=this.label_gap||null!=this.label_lineheight)&&(t='style="',null!=this.label_lineheight&&(t+=this.label_lineheight),null!=this.label_gap&&(t+=this.label_gap),t+='"');let i=`<ul class=${this.label_list_class} ${t}>`,s="";for(let e=0;e<this.articles.length;e++){let l=this.articles[e],h="popup"+e;i+="<li>"+this.get_popup_link_(h,l.name),s+=this.get_popup_content_(h,l.content)}return(i+="</ul>")+s}get_popup_link_(t,i){let s='<div class="label">';return s+=`<a href="" class="popup-open" data-modal-btn=${t}>${i}</a>`,s+="</div>"}get_popup_content_(t,i){let s=`<div class="popup-wrap" data-modal-cont=${t}>`;return s+='<div class="popup-back"></div>',s+='<div class="popup-inner"><span class="popup-close"></span><div class="popup-contents">',s+=i,s+="</div></div></div>"}}window.addEventListener("DOMContentLoaded",function(){let t=document.querySelectorAll(".popup-open"),i=document.querySelectorAll(".popup-wrap"),s=document.querySelectorAll(".popup-close"),e=document.querySelectorAll(".popup-back");for(let l=0;l<t.length;l++)t[l].addEventListener("click",function(s){s.preventDefault();let e=t[l].getAttribute("data-modal-btn");for(let h=0;h<i.length;h++)i[h].getAttribute("data-modal-cont")===e&&i[h].classList.add("active")}),e[l].addEventListener("click",function(){i[l].classList.add("active2"),setTimeout(function(){i[l].classList.remove("active"),i[l].classList.remove("active2")},300)}),s[l].addEventListener("click",function(){i[l].classList.add("active2"),setTimeout(function(){i[l].classList.remove("active"),i[l].classList.remove("active2")},300)})});