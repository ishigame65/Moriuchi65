<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/style2.css">
    <meta name="description" content="地番区画データ取得ライブラリ">
    <link rel="shortcut icon" href="../img/65.ico">
    <title>地番区画データ取得ライブラリ</title>
</head>
<style>
    /* 画面サイズに合わせた縮小表示はせず、スクロール表示で操作する前提 */
    #mapWrap {
        margin: 1em 0;
        position: relative;
        width: 928px;
        height: 928px;
        background-color: white;
        border: 1px solid gray;
    }  
    #normWrap {
        position: relative;
        width: 500px;
        height: 500px;
        border: 1px solid gray;
    }
    #mapBack {
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: url(./gmapphoto.png);
        background-repeat: no-repeat;
        opacity: 0.3;
        display: none;
    }
    #mapCanvas, #normCanvas {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    #controlPanel {
        position: absolute;
        width: 100%;
        margin-top: 1em;
        display: flex;
        justify-content: space-between;
    }
    #leftControl {
        margin-left: 1em;
    }
    #rightControl {
        padding: 0.1em 0.4em;
    }
    #checkPhoto, #checkChiban {
        margin-left: 2em;
        margin-right: 0.5em;
    }
    #buttonRedraw {
        padding: 0.15em 0.7em;
        background-color: gainsboro;
        border: solid 1px gray;
        border-radius: 2px;
        margin-left: 2em;
        margin-right: 1em;
    }
    #copyGoogle {
        position: absolute;
        bottom: 1em;
        right: 1em;
        display: none;
    }
    code {
        color: darkgoldenrod;
    }
    .classdescript {
        background-color: beige;
        padding: 0.2em 0.5em;
    }
    .classdescript dt {
        margin-top: 0.3em;
    }
    .icon {
        margin-right: 8px;
        margin-top: 0.2em;
    }
    .mailto a {
        color: #5a5c5f;
        text-decoration: none;
    }
    #lineicon {
        height: 40px;
        margin-right: 0.5em;
    }
    .lineto {
        margin-top: 0.75em;
        margin-bottom: 0.75em;
    }
    .lineto a {
        color: #5a5c5f;
        text-decoration: none;
        line-height: 40px;
    }
    #note1, #note2 {
        margin-top: 1em;
    }
</style>
<body>

<div id="wrapper"> <!-- コンテンツ部分をdivで囲む　input要素と同じ階層に配置する -->
    <main> <!-- メインコンテンツ -->
        <div class="breadcrumb">
            <ul>
                <li><a href="../index.html">Top</a></li>
                <li>地番区画データ取得ライブラリ</li>
            </ul>
        </div> <!-- breadcrumb -->

        <h2 class="mono">地番区画データ取得ライブラリ</h2>
        <div class="indent">
            登記所備付地図データ（地図XMLファイル）から地番ごとの区画形状データ（ポリゴンデータ）を抽出するとともに、
            利用しやすい座標系に変換して可視化するために開発したPythonライブラリです。
        </div>

        <section>
            <h3 class="mono">経緯</h3>
            <div class="section_content">
                所有地が複数の地番で構成され共用部分や私道持分などがある場合に、
                ご近所を含む地番区画を分かりやすく可視化できると良い（なんとなく気分的にスッキリする）。
                <ul class="indent">
                    <li>法務省が<a href="https://front.geospatial.jp/">G空間情報センター</a>で登記所備付地図データ（地図XMLファイル）を公開しており誰でも取得できる。</li>
                    <li>登記所備付地図データには公共座標系と任意座標系の二種がある。
                        <ul class="indent">
                            <li>国は公共座標系のデータ整備を推進しており、郊外地域の整備はある程度進んでいるが、都市部での整備はあまり進んでいないのが実情である。</li>
                        </ul>
                    <li>公共座標系のデータは一般的な地図アプリケーションで表示できる。
                        <ul class="indent">
                            <li>公共座標系の地図XMLファイルを一般的な地図アプリケーションで扱えるGeoJSON形式に変換するツールをデジタル庁が公開しているとともに、
                                G空間情報センターに変換済のGeoJSON形式データも公開されている。</li>
                            <li>公共座標系の地図XMLファイルをそのまま表示できる地図アプリケーションもある。</li>
                        </ul>
                    </li>
                    <li>任意座標系のデータは原点位置と方角が適当な座標系で表現されているため、一般的な地図アプリケーションで表示できない。
                        <ul class="indent">
                            <li>一部の地図アプリケーションでは任意座標系のデータをマッピングして地図上に表示する機能を有しているが、
                                この機能を他に組み込んで利用したり、表示された地図を自由に二次利用できない
                                （よく分からないが、AIを利用した画期的な技術で実現したらしい）。</li>
                        </ul>
                    </li>
                    <li>当方居住地の地図XMLファイルをダウンロードして確認したところ、残念なことに任意座標系のデータで一般的な地図アプリケーションで表示できなかった。</li>
                    <li>地図XMLファイルの中身を確認したところ、さほど複雑ではなく解析ソフトウェアを簡単に実装できそうであった。
                        そこで、任意座標系の地図XMLファイルから地番ごとの区画形状データ（ポリゴンデータ）を抽出するとともに座標系を合わせ込む機能を有するライブラリを開発し、
                        所有地を分かりやすく可視化することにした。</li>
                </ul>
            </div>
        </section>

        <section>
            <h3 class="mono">LandShapeクラス</h3>
            <div class="section_content">
                <ul class="indent">
                    <li>地番区画データ取得ライブラリで利用可能なただ一つのクラス</li>
                </ul>
                <dl class="classdescript">
                    <dt>LandShape(xmlpath, chiban_set)</dt>
                        <dd>
                            <dl><dt>引数</dt>
                            <dd>xmlpath: 地図XMLファイルパス</dd>
                            <dd>chiban_set: 対象の地番リスト</dd></dl>
                        </dd>
                        <dd>
                            コンストラクタ: 地図XMLファイルを解析して指定された地番の区画形状データを抽出する
                        </dd>
                    <dt>raw_shape()</dt>
                        <dd>
                            区画形状データ（ポリゴンデータ）を地図XMLファイル座標値（元データ形式）で取得する
                        </dd>
                    <dt>norm_shape(min, max)</dt>
                        <dd>
                            <dl><dt>引数</dt>
                            <dd>min: 正規化座標の最小値</dd>
                            <dd>max: 正規化座標の最大値</dd></dl>
                        </dd>
                        <dd>
                            区画形状データ（ポリゴンデータ）を指定値域に正規化した座標値で取得する
                        </dd>
                    <dt>fit_shape(src_pts, dst_pts)</dt>
                        <dd>
                            <dl><dt>引数</dt>
                            <dd>src_pts: 地図XMLファイルにおける四辺形四隅の頂点座標リスト</dd>
                            <dd>dst_pts: src_ptsの座標変換後の頂点座標リスト</dd></dl>
                        </dd>
                        <dd>                            
                            区画形状データ（ポリゴンデータ）を指定した四辺形に合わせるよう射影変換した座標値で取得する
                        </dd>
                </dl>
            </div>
        </section>

        <section>
            <h3 class="mono">地図XMLファイル座標値を取得</h3>
            <div class="section_content">
                <ul class="indent">
                    <li>指定した地番の区画形状データ（ポリゴンデータ）を地図XMLファイル座標値（元データ形式）で取得する<br>
                        <code>
                            from landshape import LandShape<br>
                            xmlpath = （地図XMLファイルパス）<br>
                            chiban_set = （対象の地番リスト）<br>
                            land = LandShape(xmlpath, chiban_set)<br>
                            rawshape = land.raw_shape()<br>
                            print_shape(rawshape)
                        </code>
                    </li>
                </ul>
            </div>            
        </section>

        <section>
            <h3 class="mono">正規化した座標値を取得して可視化</h3>
            <div class="section_content">
                <ul class="indent">
                    <li>指定した地番の区画形状データ（ポリゴンデータ）を値域[10, 490]に正規化した座標値で取得する<br>
                        <code>
                            from landshape import LandShape<br>
                            xmlpath = （地図XMLファイルパス）<br>
                            chiban_set = （対象の地番リスト）<br>
                            land = LandShape(xmlpath, chiban_set)<br>
                            normshape = land.norm_shape(10, 490)<br>
                            print_shape(normshape)
                        </code>
                    </li>
                    <li>取得した区画形状データ（ポリゴンデータ）座標を500x500サイズのキャンバスに描画する
                        <div id="note2" class="notes">
                            小さい画面で利用される場合はスクロールまたは画面全体を縮小してご確認ください
                        </div>
                        <div id="normWrap">
                            <canvas id="normCanvas"></canvas>
                        </div>
                    </li>
                    <li>地番区画データ描画ライブラリを利用して描画する方法は <a href="landview.html">所有地を可視化する</a> を参照</li>
                </ul>
            </div>
        </section>

        <section>
            <h3 class="mono">Googleマップに合わせるように射影変換した座標値を取得して可視化</h3>
            <div class="section_content">
                <ul class="indent">
                    <li>指定した地番の区画形状データ（ポリゴンデータ）をGoogleマップに合わせるよう射影変換した座標値で取得する<br>
                        <code>
                            from landshape import LandShape<br>
                            xmlpath = （地図XMLファイルパス）<br>
                            chiban_set = （対象の地番リスト）<br>
                            land = LandShape(xmlpath, chiban_set)<br>
                            src_pts = （地図XMLファイルにおける四辺形四隅の頂点座標リスト）<br>
                            dst_pts = （Googleマップにおける四辺形四隅の頂点座標リスト）<br>
                            fitshape = land.fit_shape(src_pts, dst_pts)<br>
                            print_shape(fitshape)
                        </code>
                    </li>
                    <li>取得した区画形状データ（ポリゴンデータ）座標をdst_ptsに合わせたサイズのキャンバスに描画する
                        <div id="note1" class="notes">
                            小さい画面で利用される場合はスクロールまたは画面全体を縮小してご確認ください
                        </div>
                        <div id="mapWrap">
                            <div id="mapBack"></div>
                            <canvas id="mapCanvas"></canvas>
                            <div id="controlPanel">
                                <div id="leftControl">
                                </div>
                                <div id="rightControl">
                                    <input type="checkbox" id="checkChiban" value="1" checked><label for="checkChiban">地番表示</label>
                                    <input type="checkbox" id="checkPhoto" value="1"><label for="checkPhoto">航空写真表示</label>
                                    <input type="button" id="buttonRedraw" value="再描画">
                                </div>
                            </div>
                        </div>
                    </li>
                    <li>指定住所居住者が所有する土地を赤系の色で塗りつぶす機能を追加した例は <a href="landview.html">所有地を可視化する</a> を参照</li>
                </ul>
            </div>
        </section>

        <section>
            <h3 class="mono">（参考）登記所備付地図データ（地図XMLファイル）を取得する方法</h3>
            <div class="section_content">                
                <ul class="indent">
                    <li><a href="https://front.geospatial.jp/">G空間情報センター</a>にログインする（事前にユーザー登録が必要）</li>
                    <li>[データセット]を選択、市区町村レベルの目的住所を入力して検索する</li>
                    <li>[登記所備付地図データ]を選択</li>
                    <li>ファイル名末尾の年号が新しいzipファイルを選択し[ダウンロード]</li>
                    <li>[利用規約を承諾する]とダウンロードが始まる</li>
                    <li>ダウンロードしたzipファイルから、対象ファイルを特定するためのcsvファイルを取り出す</li>
                    <li>csvファイルを開き、目的住所で検索して対象のzipファイル名を確認する</li>
                    <li>ダウンロードしたzipファイルから、対象のzipファイルを取り出し解凍すると目的の地図XMLファイルが得られる</li>
                </ul>
            </div>
        </section>

        <section>
            <h3 class="mono">今後について</h3>
            <div class="section_content">
                ご要望があれば、必要なファイルを提供させて頂くとともに、機能の改善や強化を検討したいと考えていますので、お気軽にご連絡ください。
                <ul class="indent">
                    <li>
                        地図XMLファイルの仕様書を見る限り、現状のライブラリは地図XMLファイル仕様のすべてをサポートしているわけではないため、
                        区画形状データの抽出に失敗する可能性があります。
                        失敗する地図XMLファイルが見つかればライブラリを改修したいと考えていますが、これまで失敗する地図XMLファイルに遭遇していないため現状のままになっています。
                        どなたかが本ライブラリを試してみて失敗する地図XMLファイルを教えて頂けると助かります。
                    </li>
                </ul>
                <dl>
                    <dt>連絡先</dt>
                    <dd>
                        <div class="mailto"><a href="mailto:moriuchi@ymail.ne.jp"><img src="../img/mail.png" class="icon">moriuchi@ymail.ne.jp</a></div>
                    </dd>
                    <dd>
                        <div class="lineto"><a href="https://lin.ee/KBpGvoV"><img src="../img/line_icon.png" alt="" id="lineicon">森内</a></div>
                    </dd>
                </dl>
            </div>
        </section>

    </main> <!-- メインコンテンツ -->
    <footer> <!-- フッターコンテンツ -->
        <div class="footer-left">
        <a href="https://www.instagram.com/moriuchi65/"><img src="../img/insta60.png" alt="Instagram" width=32 height=32></a>
        </div>
        <div class="footer-center">
        </div>
        <div class="footer-right"></div>
        <div class="clear"></div>
    </footer>
</div>

<script src="landview.min.js"></script>
<script>
    const norm_shape = {
        '6150-1':[[366.559, 234.957], [328.57, 329.133], [231.131, 290.308], [223.549, 267.553], [228.142, 255.582], [294.08, 84.631], [312.949, 76.858], [412.738, 118.778]],
        '6150-2':[[290.171, 60.765], [415.567, 111.66], [412.738, 118.778], [312.949, 76.858], [287.905, 66.34]],
        '6150-3':[[294.08, 84.631], [228.142, 255.582], [213.206, 250.152], [287.905, 66.34], [312.949, 76.858]],
        '6150-4':[[216.978, 284.672], [205.0, 315.862], [191.021, 310.158], [189.135, 309.39], [213.206, 250.152], [228.142, 255.582], [223.549, 267.553]],
        '6150-5':[[223.549, 267.553], [231.131, 290.308], [216.978, 284.672]],
        '6150-6':[[328.57, 329.133], [307.549, 381.244], [196.497, 337.75], [205.0, 315.862], [216.978, 284.672], [231.131, 290.308]],
        '6150-7':[[297.069, 407.209], [284.779, 437.676], [174.403, 394.615], [183.279, 371.768], [196.497, 337.75], [307.549, 381.244]],
        '6150-8':[[196.497, 337.75], [183.279, 371.768], [169.072, 366.232], [191.021, 310.158], [205.0, 315.862]],
        '6150-9':[[284.779, 437.676], [263.667, 490.0], [213.168, 469.473], [136.712, 438.391], [157.216, 387.945], [160.174, 389.085], [174.403, 394.615]],
        '6150-10':[[191.021, 310.158], [169.072, 366.232], [166.448, 365.212], [189.135, 309.39]],
        '6150-11':[[183.279, 371.768], [174.403, 394.615], [160.174, 389.085], [169.072, 366.232]],
        '6150-12':[[169.072, 366.232], [160.174, 389.085], [157.216, 387.945], [166.448, 365.212]],
        '6155-1':[[213.206, 250.152], [189.135, 309.39], [176.366, 304.309], [181.659, 290.491], [187.112, 276.261], [189.842, 269.135], [199.045, 245.11]],
        '6155-2':[[290.171, 60.765], [287.905, 66.34], [259.164, 54.673], [162.79, 15.559], [165.079, 10.0]],
        '6155-3':[[287.905, 66.34], [213.206, 250.152], [199.045, 245.11], [223.488, 182.975], [247.528, 121.874], [266.853, 72.751], [259.164, 54.673]],
        '6155-4':[[266.853, 72.751], [247.528, 121.874], [137.67, 76.607], [160.607, 20.868], [162.79, 15.559], [259.164, 54.673]],
        '6155-5':[[247.528, 121.874], [223.488, 182.975], [112.496, 137.784], [137.67, 76.607]],
        '6155-6':[[223.488, 182.975], [199.045, 245.11], [87.026, 199.691], [102.13, 162.98], [112.496, 137.784]],
        '6155-7':[[158.881, 265.507], [145.747, 299.488], [59.617, 266.306], [87.026, 199.691], [199.045, 245.11], [189.842, 269.135], [180.009, 273.561], [179.955, 273.538], [179.735, 273.455]],
        '6155-8':[[126.346, 349.66], [117.828, 371.692], [30.025, 338.214], [59.617, 266.306], [145.747, 299.488]],
        '6155-9':[[167.604, 284.984], [140.644, 355.196], [126.346, 349.66], [145.747, 299.488], [158.881, 265.507], [179.735, 273.455], [179.955, 273.538], [180.009, 273.561], [180.054, 273.576], [180.077, 273.584], [180.161, 273.614], [187.112, 276.261], [181.659, 290.491]],
        '6155-10':[[154.774, 360.665], [145.99, 383.587], [126.574, 434.268], [10.0, 386.88], [30.025, 338.214], [117.828, 371.692], [126.346, 349.66], [140.644, 355.196]],
        '6155-11':[[176.366, 304.309], [154.774, 360.665], [140.644, 355.196], [167.604, 284.984], [181.659, 290.491]],
        '6155-12':[[157.216, 387.945], [136.712, 438.391], [126.574, 434.268], [145.99, 383.587]],
        '6155-13':[[189.842, 269.135], [187.112, 276.261], [180.161, 273.614], [180.077, 273.584], [180.054, 273.576], [180.009, 273.561]],
        '6155-14':[[189.135, 309.39], [166.448, 365.212], [154.774, 360.665], [176.366, 304.309]],
        '6155-15':[[166.448, 365.212], [157.216, 387.945], [145.99, 383.587], [154.774, 360.665]],      
    }
    normview = new LandView('normCanvas');
    normview.draw(norm_shape, 0);

    const fit_shape = {
        '6150-1':[[533.894, 202.536], [674.471, 327.578], [546.446, 474.483], [502.274, 473.956], [484.29, 458.711], [224.956, 238.082], [222.656, 199.73], [357.866, 47.565]],
        '6150-2':[[180.416, 230.244], [347.0, 38.0], [357.866, 47.565], [222.656, 199.73], [188.905, 237.722]],
        '6150-3':[[224.956, 238.082], [484.29, 458.711], [465.683, 481.473], [188.905, 237.722], [222.656, 199.73]],
        '6150-4':[[527.945, 495.723], [574.58, 535.282], [556.095, 556.091], [553.606, 558.899], [465.683, 481.473], [484.29, 458.711], [502.274, 473.956]],
        '6150-5':[[502.274, 473.956], [546.446, 474.483], [527.945, 495.723]],
        '6150-6':[[674.471, 327.578], [751.587, 396.173], [607.149, 563.126], [574.58, 535.282], [527.945, 495.723], [546.446, 474.483]],
        '6150-7':[[789.828, 430.204], [834.557, 469.991], [691.373, 635.14], [657.602, 606.266], [607.149, 563.126], [751.587, 396.173]],
        '6150-8':[[607.149, 563.126], [657.602, 606.266], [639.275, 627.46], [556.095, 556.091], [574.58, 535.282]],
        '6150-9':[[834.557, 469.991], [911.0, 538.0], [843.951, 612.884], [742.963, 725.658], [669.258, 660.741], [673.051, 656.333], [691.373, 635.14]],
        '6150-10':[[556.095, 556.091], [639.275, 627.46], [635.898, 631.373], [553.606, 558.899]],
        '6150-11':[[657.602, 606.266], [691.373, 635.14], [673.051, 656.333], [639.275, 627.46]],
        '6150-12':[[639.275, 627.46], [673.051, 656.333], [669.258, 660.741], [635.898, 631.373]],
        '6155-1':[[465.683, 481.473], [553.606, 558.899], [536.967, 577.962], [516.311, 560.532], [495.008, 542.549], [484.327, 533.535], [448.248, 503.09]],
        '6155-2':[[180.416, 230.244], [188.905, 237.722], [150.972, 281.471], [24.459, 427.407], [16.0, 420.0]],
        '6155-3':[[188.905, 237.722], [465.683, 481.473], [448.248, 503.09], [354.864, 422.832], [262.372, 343.333], [187.528, 279.007], [150.972, 281.471]],
        '6155-4':[[187.528, 279.007], [262.372, 343.333], [116.978, 508.382], [32.532, 434.468], [24.459, 427.407], [150.972, 281.471]],
        '6155-5':[[262.372, 343.333], [354.864, 422.832], [209.02, 588.94], [116.978, 508.382]],
        '6155-6':[[354.864, 422.832], [448.248, 503.09], [301.486, 669.861], [246.737, 621.947], [209.02, 588.94]],
        '6155-7':[[459.104, 585.019], [509.857, 627.97], [400.23, 756.281], [301.486, 669.861], [448.248, 503.09], [484.327, 533.535], [485.976, 553.249], [485.905, 553.328], [485.625, 553.66]],
        '6155-8':[[584.425, 691.094], [617.038, 718.697], [505.951, 848.818], [400.23, 756.281], [509.857, 627.97]],
        '6155-9':[[498.163, 581.568], [602.743, 669.82], [584.425, 691.094], [509.857, 627.97], [459.104, 585.019], [485.625, 553.66], [485.905, 553.328], [485.976, 553.249], [486.031, 553.179], [486.058, 553.144], [486.162, 553.017], [495.008, 542.549], [516.311, 560.532]],
        '6155-10':[[620.861, 648.767], [654.829, 677.439], [729.619, 740.558], [577.0, 911.0], [505.951, 848.818], [617.038, 718.697], [584.425, 691.094], [602.743, 669.82]],
        '6155-11':[[536.967, 577.962], [620.861, 648.767], [602.743, 669.82], [498.163, 581.568], [516.311, 560.532]],
        '6155-12':[[669.258, 660.741], [742.963, 725.658], [729.619, 740.558], [654.829, 677.439]],
        '6155-13':[[484.327, 533.535], [495.008, 542.549], [486.162, 553.017], [486.058, 553.144], [486.031, 553.179], [485.976, 553.249]],
        '6155-14':[[553.606, 558.899], [635.898, 631.373], [620.861, 648.767], [536.967, 577.962]],
        '6155-15':[[635.898, 631.373], [669.258, 660.741], [654.829, 677.439], [620.861, 648.767]],
    }

    mapview = new LandView('mapCanvas', 1);
    mapview.draw(fit_shape, 1);

    const checkChiban = document.getElementById('checkChiban');
    let mode = checkChiban.checked ? 1 : 0;
    checkChiban.addEventListener('change', function() {
        mode = this.checked ? 1 : 0;
        mapview.draw(fit_shape, mode);
    });

    const mapBack = document.getElementById('mapBack');
    const checkPhoto = document.getElementById('checkPhoto');
    checkPhoto.addEventListener('change', function() {
        if (this.checked) {
            mapBack.style.display = 'block';
        } else {
            mapBack.style.display = 'none';
        }
    });

    const buttonRedraw = document.getElementById('buttonRedraw');
    buttonRedraw.addEventListener('click', function() {
        mapview.draw(fit_shape, mode);
    });
</script>
</body>
</html>
